apiVersion: batch/v1
kind: Job
metadata:
  name: localstack-dynamodb-init
  namespace: localstack
spec:
  backoffLimit: 3
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: init
          image: amazon/aws-cli:2.15.57
          env:
            - name: AWS_ACCESS_KEY_ID
              value: test
            - name: AWS_SECRET_ACCESS_KEY
              value: test
            - name: AWS_DEFAULT_REGION
              value: sa-east-1
            - name: ENDPOINT_URL
              value: http://localstack.localstack.svc.cluster.local:4566
          command: ["sh","-c"]
          args:
            - |
              
              echo "Creating table: table1"
              aws --endpoint-url="$ENDPOINT_URL" dynamodb create-table \
                --table-name "table1" \
                --attribute-definitions AttributeName=pk,AttributeType=S \
                --key-schema AttributeName=pk,KeyType=HASH \
                --billing-mode PAY_PER_REQUEST \
              || true

              echo "Tables:"
              aws --endpoint-url="$ENDPOINT_URL" dynamodb list-tables

              echo "Put Item"
              awslocal dynamodb put-item \
              --region sa-east-1 \
              --table-name table1 \
              --item '{
                "pk":        { "S": "user#123" },
                "email":     { "S": "user@test.com" },
                "status":    { "S": "ACTIVE" },
                "isActive":  { "BOOL": true },
                "createdAt": { "S": "2026-02-05T12:00:00Z" },
                "role":      { "S": "ADMIN" },
                "version":   { "N": "1" }
              }'