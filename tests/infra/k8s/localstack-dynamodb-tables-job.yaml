apiVersion: batch/v1
kind: Job
metadata:
  name: localstack-dynamodb-init
  namespace: localstack
spec:
  backoffLimit: 3
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: init
          image: amazon/aws-cli:2.15.57
          env:
            - name: AWS_ACCESS_KEY_ID
              value: test
            - name: AWS_SECRET_ACCESS_KEY
              value: test
            - name: AWS_DEFAULT_REGION
              value: us-east-1
            - name: ENDPOINT_URL
              value: http://localstack.localstack.svc.cluster.local:4566
          command: ["sh","-c"]
          args:
            - |
              set -euo pipefail

              echo "Waiting LocalStack..."
              for i in $(seq 1 60); do
                if aws --endpoint-url="$ENDPOINT_URL" dynamodb list-tables >/dev/null 2>&1; then
                  echo "LocalStack ready"
                  break
                fi
                sleep 2
              done

              create_table () {
                local name="$1"
                echo "Creating table: ${name}"
                aws --endpoint-url="$ENDPOINT_URL" dynamodb create-table \
                  --table-name "${name}" \
                  --attribute-definitions AttributeName=pk,AttributeType=S \
                  --key-schema AttributeName=pk,KeyType=HASH \
                  --billing-mode PAY_PER_REQUEST \
                || true
              }

              create_table table1
              create_table table2
              create_table table3

              echo "Tables:"
              aws --endpoint-url="$ENDPOINT_URL" dynamodb list-tables